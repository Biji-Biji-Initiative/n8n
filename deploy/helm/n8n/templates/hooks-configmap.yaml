{{- if .Values.forwardAuth.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "n8n.fullname" . }}-hooks
  labels:
    {{- include "n8n.labels" . | nindent 4 }}
data:
  hooks.js: |
    // Forward Auth SSO Hook for n8n
    // Auto-login users based on trusted proxy headers (e.g., from Authentik)
    const { dirname, resolve } = require('path')
    const { issueCookie } = require(resolve(dirname(require.resolve('n8n')), 'auth/jwt'))
    const ignoreAuthRegexp = /^\/(assets|healthz|webhook|rest\/oauth2-credential)/

    module.exports = {
        n8n: {
            ready: [
                async function ({ app }, config) {
                    // Register middleware using Express' public API to avoid relying on internal modules
                    // that may change between n8n/express versions.
                    app.use(async (req, res, next) => {
                        if (ignoreAuthRegexp.test(req.url)) return next()
                        if (!config.get('userManagement.isInstanceOwnerSetUp', false)) return next()
                        if (req.cookies?.['n8n-auth']) return next()
                        if (!process.env.N8N_FORWARD_AUTH_HEADER) return next()

                        const email = req.headers[process.env.N8N_FORWARD_AUTH_HEADER.toLowerCase()]
                        if (!email) return next()

                        // Load user with role relation (required for issueCookie)
                        const user = await this.dbCollections.User.findOne({
                            where: { email },
                            relations: ['role']
                        })
                        if (!user) {
                            res.statusCode = 401
                            res.end(`User ${email} not found in n8n. Please set up the owner account first.`)
                            return
                        }

                        // issueCookie(res, user, usedMfa, browserId)
                        issueCookie(res, user, false)
                        return next()
                    })
                },
            ],
        },
    }
{{- end }}
